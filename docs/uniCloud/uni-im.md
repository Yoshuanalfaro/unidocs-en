> 本插件APP端需要HBuilderX 3.6.9 及其以上版本支持，微信小程序和网页端需要HBuilderX 3.6.4 及其以上版本支持。
> The APP side of this plug-in needs the support of HBuilderX 3.6.9 and above, and the WeChat MiniApp and web page need the support of HBuilderX 3.6.4 and above.

# 简介
# Introduction
uni-im是云端一体的、全平台的、免费的、开源即时通讯系统。
uni-im is a cloud-integrated, full-platform, free and open-source instant messaging system.
- 基于uni-app，App、小程序、web全端兼容
- Based on uni-app, App, MiniApp, and web are fully compatible
- 基于uniCloud，前后端都使用js开发
- Based on uniCloud, both the front and back ends are developed using js
- 基于[uni-push2](https://uniapp.dcloud.net.cn/unipush-v2.html)，专业稳定的全端推送系统
- Based on [uni-push2](https://uniapp.dcloud.net.cn/unipush-v2.html), a professional and stable full-end push system
- 基于[uni-id](https://uniapp.dcloud.net.cn/uniCloud/uni-id-summary.html)，完善的账户体系
- Based on [uni-id](https://uniapp.dcloud.net.cn/uniCloud/uni-id-summary.html), a complete account system

案例：打开[插件市场](https://ext.dcloud.net.cn/plugin?id=55)，点击咨询作者按钮
Case: Open the [plug-in market](https://ext.dcloud.net.cn/plugin?id=55), click the button to consult the author

下载地址：[https://ext.dcloud.net.cn/plugin?name=uni-im](https://ext.dcloud.net.cn/plugin?name=uni-im)
Download address: [https://ext.dcloud.net.cn/plugin?name=uni-im](https://ext.dcloud.net.cn/plugin?name=uni-im)

## uni-im 使用uniCloud产生的费用说明@cost
## uni-im Description of the cost generated by using uniCloud @cost

uni-im本身并不收费，实际使用中需要依赖uniCloud云服务，会产生费用；而uniCloud的价格很实惠：  
uni-im itself does not charge any fees. In actual use, it needs to rely on uniCloud cloud services, which will incur fees; and the price of uniCloud is very affordable:
- 调用10000次云函数仅需0.0133元
- It only costs 0.0133 yuan to call cloud functions 10,000 times
- 调用10000次数据库查询仅需0.015元
- It only costs 0.015 yuan to call 10,000 database queries
> 更多计费参考：[阿里云版uniCloud按量计费文档](https://uniapp.dcloud.net.cn/uniCloud/price.html#aliyun-postpay)
> More billing reference: [Aliyun version uniCloud pay-as-you-go document](https://uniapp.dcloud.net.cn/uniCloud/price.html#aliyun-postpay)

### 举例说明：
### for example:

- 单聊场景，向用户发送一条消息的过程：
- Single chat scenario, the process of sending a message to the user:
1. 调用uni-im-co云对象的sendMsg方法（产生1次云函数请求）
1. Call the sendMsg method of the uni-im-co cloud object (generate a cloud function request)
2. 查询当前对话的会话记录（产生1次云数据库读操作）
2. Query the session record of the current conversation (generate 1 cloud database read operation)
3. 根据步骤2的查询结果，如果已经有会话记录，就更新会话，否则就创建一条会话记录（产生1次云数据库写操作）
3. According to the query result of step 2, if there is a session record, update the session, otherwise, create a session record (generate 1 cloud database write operation)
4. 查询发送消息的用户信息，用于接收消息时在通知栏显示发送者昵称和头像（产生1次云数据库读操作）
4. Query the information of the user who sent the message, which is used to display the sender's nickname and avatar in the notification bar when receiving the message (generates a cloud database read operation)
5. 记录发送的消息内容到数据库，用于保存消息历史记录（产生1次云数据库写操作）
5. Record the sent message content to the database to save the message history (generate 1 cloud database write operation)
6. 以`user_id`为标识通过`uni-push2`向用户发送消息会产生0.00000283元uniCloud使用费用[详情查看](https://uniapp.dcloud.net.cn/unipush-v2.html#cost)
6. Sending a message to a user through `uni-push2` with `user_id` as the identifier will generate a uniCloud usage fee of 0.00000283 yuan [View details](https://uniapp.dcloud.net.cn/unipush-v2.html#cost)

合计：1次云函数请求、2次数据库读操作、2次数据库写操作、1次uni-push2推送操作，即 (1x0.0133 + 2x0.015 + 2x0.05 + 1x0.0283)/10000 ≈ 0.000017元

- 群聊场景，向用户发送一条消息的过程：
- Group chat scenario, the process of sending a message to the user:
1. 调用uni-im-co云对象的sendMsg方法（产生1次云函数请求）
1. Call the sendMsg method of the uni-im-co cloud object (generate a cloud function request)
2. 查询当前用户是否为群成员，防止非群成员发送消息（产生1次云数据库读操作）
2. Query whether the current user is a group member, and prevent non-group members from sending messages (generate 1 cloud database read operation)
3. 查询当前对话的会话记录（产生1次云数据库读操作）
3. Query the session record of the current conversation (generate 1 cloud database read operation)
4. 根据步骤3的查询结果，如果已经有会话记录，就更新会话，否则就创建一条会话记录（产生1次云数据库写操作）
4. According to the query result of step 3, if there is already a session record, update the session, otherwise, create a session record (generate 1 cloud database write operation)
5. 查询发送消息的用户信息，用于接收消息时在通知栏显示发送者昵称和头像（产生1次云数据库读操作）
5. Query the information of the user who sent the message, which is used to display the sender's nickname and avatar in the notification bar when receiving the message (generates a cloud database read operation)
6. 记录发送的消息内容到数据库，用于保存消息历史记录（产生1次云数据库写操作）
6. Record the sent message content to the database to save the message history (generate 1 cloud database write operation)
7. 以群id为参数，调用uni-im-co云对象的sendMsgToGroup方法，这是一个递归方法每次向500名群成员推送消息（如果群成员数量为0-500只需执行1次，500-1000需执行2次，以此类推），（会产生最少1次数据库读操作，和1次以`user_id`为标识通过`uni-push2`向用户发送消息会产生0.00000283元uniCloud使用费用[详情查看](https://uniapp.dcloud.net.cn/unipush-v2.html#cost)）
7. With the group id as a parameter, call the sendMsgToGroup method of the uni-im-co cloud object, which is a recursive method to push messages to 500 group members each time (if the number of group members is 0-500, it only needs to be executed once, 500 -1000 needs to be executed 2 times, and so on), (at least 1 database read operation will be generated, and 1 time to send a message to the user through `uni-push2` with `user_id` as the identifier will generate 0.00000283 yuan uniCloud usage fee [details View](https://uniapp.dcloud.net.cn/unipush-v2.html#cost))

合计：向500人群发送消息，会产生：1次云函数请求、4次数据库读操作、2次数据库写操作、1次uni-push2推送操作，即 (1x0.0133 + 4x0.015 + 2x0.05 + 1x0.0283)/10000 ≈ 0.000020元

相比行业内同类型产品，uni-im仅收取如此便宜的uniCloud（serverless服务器）费用；在价格这块uni-im性价比极高。
Compared with the same type of products in the industry, uni-im only charges such a cheap uniCloud (serverless server) fee; in terms of price, uni-im is extremely cost-effective.

## 特点优势  
## Features and advantages
- 全端可用
- full end available
- App端支持nvue，更好的长列表性能。list组件性能优势[详情参考](https://uniapp.dcloud.net.cn/component/list.html)
- App side supports nvue, better long list performance. List component performance advantages [details reference](https://uniapp.dcloud.net.cn/component/list.html)
- 智能本地缓存，更快的历史消息加载速度，更小的网络请求压力
- Smart local cache, faster loading of historical messages, less pressure on network requests
- 中心化响应式数据管理，切换会话不重头加载数据，更流畅的体验
- Centralized responsive data management, switching sessions without reloading data, smoother experience
- App端聚合多个手机厂商推送通道，app不在线也可以收到消息
- The app aggregates multiple mobile phone manufacturers' push channels, and the app can receive messages even when the app is offline

## 版本计划  
## version plan
### 已上线
### is live
- 应用内嵌入uni-im，使用户方便、实时的与App运营者互动，咨询问题、反馈意见、进行投诉。
- Embed uni-im in the app, enabling users to interact with the app operator conveniently and in real time, to ask questions, give feedback, and make complaints.
- 可发送文字、图片、音频、视频、代码、任意文件
- Can send text, pictures, audio, video, code, any file
- im交友场景：群聊、好友关系
- im dating scene: group chat, friendship

### 后续计划
### Subsequent plans
1. 通信方式扩展：音频通话、视频通话
1. Expansion of communication methods: audio calls, video calls
2. 细节完善：聊天记录识别电话邮件、消息删除和批删、消息回复、消息转发和批转、消息撤回、勿扰设置、会话置顶、留言转文字、图片提取文字
2. Perfect details: chat records identify phone emails, message deletion and batch deletion, message reply, message forwarding and forwarding, message withdrawal, do not disturb setting, conversation top, message transfer to text, picture extraction text
3. 客服场景：管理端支持座席
3. Customer service scenario: the management side supports agents

优先开发哪些，取决于开发者的反馈。同时也欢迎开发者共建这个开源项目。
Which ones are prioritized depends on developer feedback. At the same time, developers are also welcome to build this open source project.

> uni-im相关功能建议或问题交流，暂时请加QQ群号:[854520009](https://qm.qq.com/cgi-bin/qm/qr?k=DJNSajXAYHnYcr9pouOfxF9Rwwl1AJHc&jump_from=webapi&authKey=HZ1fG58Eudp3o0GCoyx1/UPMY9Fv1sGT5jdqYqPJlTGT0XVUip3Bk8E+UyToQOMo)。后续uni-im支持群聊后会废除QQ改为uni-im。
> For uni-im related function suggestions or questions, please add the QQ group number: [854520009](https://qm.qq.com/cgi-bin/qm/qr?k=DJNSajXAYHnYcr9pouOfxF9Rwwl1AJHc&jump_from=webapi&authKey=HZ1fG58Eudp3o0GCoyTYx1/UPMY9Fv3EsGTJ5jd UyToQOMo). After uni-im supports group chat in the future, QQ will be abolished and changed to uni-im.

### 已知bug
### Known bugs
- Mac端Safari浏览器，消息列表界面滚动到顶部无法自动加载历史消息
- In the Safari browser on the Mac, the message list interface cannot automatically load historical messages when scrolling to the top

# 快速部署体验
# Rapid deployment experience
## 前提条件
## prerequisites
1. 开通uniCloud并创建服务空间 [控制面板](https://unicloud.dcloud.net.cn/)
1. Open uniCloud and create a service space [Control Panel](https://unicloud.dcloud.net.cn/)
2. 开通`uni-push2.0`[详情参考](https://uniapp.dcloud.net.cn/unipush-v2.html#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E5%BC%80%E9%80%9A)
2. Activate `uni-push2.0` [details reference](https://uniapp.dcloud.net.cn/unipush-v2.html#%E7%AC%AC%E4%B8%80%E6%AD% A5-%E5%BC%80%E9%80%9A)

## 体验步骤
## Experience steps

1. 打开`uni-im`插件下载地址：[https://ext.dcloud.net.cn/plugin?name=uni-im](https://ext.dcloud.net.cn/plugin?name=uni-im)
1. Open `uni-im` plug-in download address: [https://ext.dcloud.net.cn/plugin?name=uni-im](https://ext.dcloud.net.cn/plugin?name= uni-im)
2. 点击`使用HBuilderX导入示例项目`
2. Click `Import sample project using HBuilderX`
3. 按提示，通过云服务空间初始化向导部署项目（注意：选择绑定的服务空间，须在uni-push2.0的[web控制台](https://dev.dcloud.net.cn/pages/app/push2/info)关联）
3. According to the prompt, deploy the project through the cloud service space initialization wizard (note: to select the bound service space, it must be in the [web console] of uni-push2.0(https://dev.dcloud.net.cn/pages /app/push2/info) association)
4. `运行项目`到2个不同的浏览器，因为在同一个浏览器打开相同网络地址（ip或者域名）的uni-im项目，socket会相互占线。
4. `Run project` to two different browsers, because opening the uni-im project with the same network address (ip or domain name) in the same browser, the sockets will be busy with each other.
	所以需要使用两个浏览器（或者使用浏览器`打开新的无痕式窗口`功能充当第二个浏览器）分别`注册账号并登录`，
	So you need to use two browsers (or use the browser's `open a new incognito window` function to act as a second browser) to `register an account and log in` respectively,
	到此部署已经结束
	The deployment has ended
5. 向对应的用户发起会话，通过访问路径：`/uni_modules/uni-im/pages/chat/chat?user_id=` + `对应的用户id` 即可
5. Initiate a session with the corresponding user through the access path: `/uni_modules/uni-im/pages/chat/chat?user_id=` + `corresponding user id`

## 部署到自己的项目
## Deploy to your own project
1. 打开`uni-im`插件下载地址：[https://ext.dcloud.net.cn/plugin?name=uni-im](https://ext.dcloud.net.cn/plugin?name=uni-im)
1. Open `uni-im` plug-in download address: [https://ext.dcloud.net.cn/plugin?name=uni-im](https://ext.dcloud.net.cn/plugin?name= uni-im)
2. 点击`使用HBuilderX导入插件`，选择你的项目，点击确定（同时会自动导入依赖的uni_modules`uni-id-pages`）按提示操作自动配置`pages.json`
2. Click `Use HBuilderX to import plug-ins`, select your project, and click OK (at the same time, the dependent uni_modules`uni-id-pages` will be automatically imported) Follow the prompts to automatically configure `pages.json`
3. 打开项目根目录的App.vue文件，初始化uni-id-pages和uniIm模块
3. Open the App.vue file in the root directory of the project and initialize the uni-id-pages and uniIm modules
示例如下：
Examples are as follows:

```html
<script>
	//1. 导入uni身份信息管理模块
	//1. Import uni identity information management module
	import uniIdPagesInit from '@/uni_modules/uni-id-pages/init.js';
	//2. 导入uniIm的Utils工具类
	//2. Import the Utils tool class of uniIm
	import uniImUtils from '@/uni_modules/uni-im/common/utils.js';
	export default {
		onLaunch: async function() {
			console.log('App Launch');
			//3. 初始化uni身份信息管理模块
			//3. Initialize the uni identity information management module
			uniIdPagesInit();
			//4. 初始化uniIm
			//4. Initialize uniIm
			uniImUtils.init();
		},
		onShow: function() {
			console.log('App Show');
		},
		onHide: function() {
			console.log('App Hide');
		}
	};
</script>
```

4. 启用Vuex并引入uni-im的store
4. Enable Vuex and introduce uni-im store
- 打开项目根目录的main.js文件启用Vuex
- Open the main.js file in the root directory of the project to enable Vuex
```js
	import App from './App'
	import store from './store'

	// #ifndef VUE3
	import Vue from 'vue'
	Vue.config.productionTip = false
	Vue.prototype.$store = store
	App.mpType = 'app'
	const app = new Vue({
		store,
		...App
	})
	app.$mount()
	// #endif

	// #ifdef VUE3
	import {createSSRApp} from 'vue'
	export function createApp() {
		const app = createSSRApp(App)
		app.use(store)
		return {app}
	}
	// #endif
```

- 项目根目录创建文件夹store，并在此目录下新建入口文件`index.js`引入uni-im的store
- Create a folder store in the root directory of the project, and create a new entry file `index.js` in this directory to import the store of uni-im
```js
	// 文件路径：/store/index.js
	// File path: /store/index.js
	import uniIm from '@/uni_modules/uni-im/common/store'

	// #ifndef VUE3
	import Vue from 'vue'
	import Vuex from 'vuex'
	Vue.use(Vuex)
	const store = new Vuex.Store({
		modules: {
			uniIm
		},
		strict: true
	})
	// #endif
	// #ifdef VUE3
	import {createStore} from 'vuex'
	const store = createStore({
		modules: {
			uniIm
		}
	})
	// #endif
	export default store
```

5. 账号打通
5. Open the account

uni-im经常用于嵌入其他App中，成为其中的一个模块。比如客服模块。这就涉及现有应用和uni-im的账户打通问题。
uni-im is often used to embed in other apps and become one of the modules. Such as customer service module. This involves the problem of getting through the accounts of existing applications and uni-im.

uni-im的账户体系是uni-id的。如果开发者的现有应用要接入uni-im，但账户体系并不在uni-id里，或使用的是老版uni-id，就需要参考本章节打通账户。
The account system of uni-im is uni-id. If the developer's existing application needs to be connected to uni-im, but the account system is not in uni-id, or the old version of uni-id is used, you need to refer to this chapter to open the account.

- 基于`uni-id-pages`的项目，直接登录即可，无需额外打通工作。
- Based on the `uni-id-pages` project, you can log in directly without additional work.
- 基于`uni-id-co`的项目，需要在登录成功和用户信息更新时，同步更新uniId store内的当前用户信息（uni-im显示当前用户头像、昵称时会用到）示例代码：
- For projects based on `uni-id-co`, when the login is successful and the user information is updated, the current user information in the uniId store needs to be updated synchronously (this will be used when uni-im displays the current user avatar and nickname). Sample code:
```js
	//导入uniCloud客户端账户体系，用户信息状态管理模块
	//Import uniCloud client account system, user information status management module
	import {mutations as uniIdMutations} from '@/uni_modules/uni-id-pages/common/store.js';
	await uniIdMutations.updateUserInfo()
```
- 基于老版uni-id(版本号：3.x) 开发的项目，需要如下改造：
- Projects developed based on the old version of uni-id (version number: 3.x) need to be modified as follows:
	1. 在登录成功和token续期后，绑定当前账号与设备推送标识的关联关系。示例代码：
	1. After the login is successful and the token is renewed, bind the relationship between the current account and the device push ID. Sample code:
```js
	const uniIdCo = uniCloud.importObject("uni-id-co", {customUI: true})
	uni.getPushClientId({
		success: async function(e) {
			console.log(e)
			let pushClientId = e.cid
			let res = await uniIdCo.setPushCid({
				pushClientId
			})
			console.log('getPushClientId', res);
		},
		fail(e) {
			console.error(e)
		}
	})
```
	2. 在登录成功和用户信息更新时，同步更新uniId store内的当前用户信息（uni-im显示当前用户头像、昵称时会用到）示例代码：
	2. When the login is successful and the user information is updated, the current user information in the uniId store will be updated synchronously (this will be used when uni-im displays the current user avatar and nickname) Sample code:
```js
	//导入uniCloud客户端账户体系，用户信息状态管理模块
	//Import uniCloud client account system, user information status management module
	import {mutations as uniIdMutations} from '@/uni_modules/uni-id-pages/common/store.js';
	await uniIdMutations.updateUserInfo()
```
- 客户端是uni-app的，但服务器不是uniCloud的情况。需开通uniCloud，然后在客户端通过uni-im-co的loginWithJWT方法实现联登，因内容较多，需另见[文档](#uniImCoLoginWithJWT)。
- The client is uni-app, but the server is not uniCloud. You need to open uniCloud, and then use the loginWithJWT method of uni-im-co to realize the login on the client side. Due to the large content, please refer to [documentation](#uniImCoLoginWithJWT).
- 客户端如果不是uni-app的，如果是网页，可iframe内嵌。如果是app，可嵌入[uni小程序sdk](https://nativesupport.dcloud.net.cn/README)
- If the client is not a uni-app, if it is a web page, it can be embedded in an iframe. If it is an app, it can be embedded in [uni MiniApp sdk](https://nativesupport.dcloud.net.cn/README)

6. 确保账户对接成功后，打开“用户列表页”，路径：`/uni_modules/uni-im/pages/userList/userList`可以看到所有的注册用户（默认仅登录的账号为超级管理员才有权限访问，你也可以根据自己的业务需求修改`uniCloud/database/uni-id-users.schema.json`配置权限[更多详情](https://uniapp.dcloud.net.cn/uniCloud/schema.html#permission)）
6. After making sure the account connection is successful, open the "User List Page", the path: `/uni_modules/uni-im/pages/userList/userList`, you can see all registered users (by default, only the logged-in account is a super administrator. Permission access, you can also modify `uniCloud/database/uni-id-users.schema.json` configuration permissions according to your business needs [more details](https://uniapp.dcloud.net.cn/uniCloud/schema .html#permission))
7. 点击某个用户，会自动创建与该用户的会话，并打开“聊天对话页”（路径：`/uni_modules/uni-im/pages/chat/chat`），然后就可以开始聊天了。
7. Clicking on a user will automatically create a session with the user, and open the "chat dialogue page" (path: `/uni_modules/uni-im/pages/chat/chat`), and then you can start chatting.
8. 还可以导入uni-im的示例项目作为管理员端与用户聊天。
8. You can also import the sample project of uni-im as an administrator to chat with users.
9. 如果你是2个不同appId的应用相互通讯（比如：淘宝的买家端和卖家端通讯）的场景，请打开聊天对话文件（路径：`/uni_modules/uni-im/pages/chat/chat`）搜索`data.appId = this.systemInfo.appId`修改`this.systemInfo.appId`为相对的appId
9. If you are two applications with different appIds communicating with each other (for example: Taobao’s buyer-side and seller-side communication), please open the chat dialogue file (path: `/uni_modules/uni-im/pages/chat/chat `) Search `data.appId = this.systemInfo.appId` Modify `this.systemInfo.appId` to relative appId


**补充：**（基于uni-id-pages开发的项目可忽略）
**Supplement:** (projects developed based on uni-id-pages can be ignored)

为了实现用户退出登录后，不再收到im消息，需要在执行退出登录时同步状态给uni-id-pages。示例代码如下：
In order to prevent the user from receiving IM messages after logging out, it is necessary to synchronize the status to uni-id-pages when logging out. The sample code is as follows:
```js
import {mutations as uniIdMutations} from '@/uni_modules/uni-id-pages/common/store.js'
uniIdMutations.logout()
```


## 限制普通用户向其他用户发起会话
## Restrict ordinary users from initiating sessions to other users
客服场景下，我们希望管理员客服可以向任意用户发起会话。而普通用户的会话对象只能是客服。
In the customer service scenario, we hope that the administrator customer service can initiate a session with any user. The conversation object of ordinary users can only be customer service.
- 客户端限制  
- client limit
删除或隐藏“用户列表页”和“会话列表页”，仅保留“聊天对话页”。并绘制按钮，如：“联系客服”，点击后打开“聊天对话页” 
Delete or hide the "User List Page" and "Conversation List Page", leaving only the "Chat Conversation Page". And draw a button, such as: "Contact Customer Service", click to open the "Chat Dialogue Page"
逻辑代码如下：
The logic code is as follows:
```js
uni.navigateTo({
	url:'/uni_modules/uni-im/pages/chat/chat?user_id=' + 对应的用户id
})
```

- 服务端限制  
- Server-side restrictions

1. 添加`uni-im`配置文件，打开：`/uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/`；新建`uni-im`文件夹和`config.json`文件，示例如下：
1. Add `uni-im` configuration file, open: `/uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/`; create `uni-im` folder and `config.json `file, for example:
```json
{
	"admin_uid":false
}
```

2. 配置`admin_uid`的值为管理员客服的user_id（支持多个以数组的形式指定），如果会话双方均不属于此域则无法通讯。不配置或为false则表示不限制。
2. Configure the value of `admin_uid` to be the user_id of the administrator customer service (multiple can be specified in the form of an array). If both parties in the session do not belong to this domain, communication will not be possible. If not configured or set to false, it means unlimited.

# 开发文档  
# Development documentation
## 目录结构  
## Directory Structure  
<pre v-pre="" data-lang="">
<code class="lang-" style="padding:0">
├─uni_modules                                         存放[uni_module](/uni_modules)规范的插件。
│    ├─其他module
│    └─uni-im
│        ├─uniCloud
│        │    ├─cloudfunctions                        云函数目录
│        │    │    └─uni-im-co                        集成调用uni-im方法的云对象
│        │    └─database
│        │    	├─uni-im-conversation.schema.json     聊天会话表的表结构
│        │    	└─uni-im-msg.schema.json              聊天消息表的表结构
│        ├─common
│        │    ├─msgManager.js                         消息管理类库
│        │    ├─store.js                              状态管理
│        │    ├─utils.js                              工具类库
│        │    └─uni-im-storage.js                     封装storage操作库
│        ├─components
│        │    └─uni-im-msg                            显示聊天消息气泡组件
│        ├─pages
│        │    ├─chat
│        │    │    └─chat.nvue                        聊天对话页
│        │    ├─index                    
│        │    │     └─index.nvue                      会话列表页
│        │    └─userList                    
│        │         └─userList.vue                     用户列表页
│        ├─static                                     静态资源目录
│        │    └─avatarUrl.png                         默认用户头像图片资源
│        ├─changelog.md                               更新日志
│        ├─package.json                               包管理文件
│        └─readme.md                                  插件自述文件
</code>
</pre>

uni-im v1.0.0 暂时比较简单，云端有1个云对象`uni-im-co`，2个opendb数据表（会话表`uni-im-conversation`，聊天消息表`uni-im-msg`）
uni-im v1.0.0 is relatively simple for now, there is 1 cloud object `uni-im-co` in the cloud, 2 opendb data tables (session table `uni-im-conversation`, chat message table `uni-im-msg` )

名词解释
Glossary
- 聊天会话ID  
- chat session id
根据通讯双方用户id，生成的唯一索引值；
The unique index value generated according to the user id of both communication parties;
- 聊天会话  
- chat session
以会话ID为索引的一组数据，记录：未读消息数量、会话更新时间、会话类型、会话所属用户的id、对话的用户id、对话的群id、最后一条消息概述（文本消息的前15个字，消息为多媒体时只描述类型）
A set of data indexed by the session ID, records: number of unread messages, session update time, session type, user id of the session, user id of the conversation, group id of the conversation, last message overview (the first 15 text messages words, only describe the type when the message is multimedia)

## uni-im-co 云函数（云对象）
## uni-im-co cloud function (cloud object)
### API列表
### API list
|API				|描述											|
| API | Description |
|--					|--												|
|loginWithJWT		|基于jwt签名的账号登录方式[见下方](#uniImCoLoginWithJWT)				|
| loginWithJWT |Account login method based on jwt signature [see below](#uniImCoLoginWithJWT) |
|getConversationList|获取会话列表[见下方](#coGetConversationList)	|
| getConversationList|Get Conversation List [see below](#coGetConversationList) |
|sendMsg			|发送聊天消息[见下方](#coSendMsg)				|
| sendMsg | Send a chat message [see below](#coSendMsg) |

#### 账号登录loginWithJWT@uniImCoLoginWithJWT
#### Account login loginWithJWT@uniImCoLoginWithJWT

如果你的项目是基于非uniCloud开发的项目（比如：应用服务端的开发语言是php、java等，用户信息并没未存储在uniCloud云数据库中）需要通过跨平台签名认证的方式，向uniCloud账户体系新增用户（创建过则更新用户信息）并获取token实现登录。
If your project is based on a non-uniCloud development project (for example: the development language of the application server is php, java, etc., and the user information is not stored in the uniCloud cloud database), you need to pass the cross-platform signature authentication method and submit to the uniCloud account system Add a new user (update user information after creation) and get token to log in.

前置要求：添加`uni-im`配置文件，打开：`/uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/`；新建`uni-im`文件夹和`config.json`文件，示例如下：
Pre-requirements: add `uni-im` configuration file, open: `/uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/`; create a new `uni-im` folder and `config .json` file, the example is as follows:
```json
{
	"jwtSecret":"jwtSecretDemo",
}
```
这里的值`jwtSecretDemo`为示例，注意修改为自己的，使用一个较长的字符串即可（越长安全性越高，建议大于32位）。
The value `jwtSecretDemo` here is an example, pay attention to modify it to your own, and use a longer string (the longer the string, the higher the security, it is recommended to be greater than 32 bits).

**接口形式**
**Interface form**

```js
await uniImCo.loginWithJWT(signedData)
```

signedData 为通过<a target="_blank" href="https://jwt.io">jwt</a>签名后的数据
signedData is the data signed by <a target="_blank" href="https://jwt.io">jwt</a>

> 各类计算机语言，jwt库下载地址：<a target="_blank" href="https://jwt.io/libraries">https://jwt.io/libraries</a>
> Various computer languages, jwt library download address: <a target="_blank" href="https://jwt.io/libraries">https://jwt.io/libraries</a>

**signedData 包含的数据说明**
**Description of data contained in signedData**

| 字段		| 类型		|必填	| 描述							|
| Field | Type | Required | Description |
| --		| --		| --	| --							|
| exp		| timestamp	| 否	    | 签名数据的过期时间					|
| exp | timestamp | no | expiration time of signature data |
| userInfo	| Object	| 是	    | 用户信息[详情](#signedDataUserInfo)	|
| userInfo | Object | Yes | User Information [Details](#signedDataUserInfo) |

**userInfo 参数说明 @signedDataUserInfo**
**userInfo parameter description @signedDataUserInfo**

| 字段				| 类型	|必填| 描述											|
| Field | Type | Required | Description |
| --				| --	| --| --											|
| openid			| String| 是	| 原系统的用户id									|
| openid | String| Yes | the user id of the original system |
| nickname			| String| 否	| 用户昵称										|
| nickname | String| No | User nickname |
| avatar_file		| file	| 否	| 用户头像文件对象									|
| avatar_file | file | no | user avatar file object |
| gender			| int	| 否	| 用户性别：0 未知 1 男性 2 女性					|
| gender | int | No | User gender: 0 unknown 1 male 2 female |
| mobile			| String| 否	| 手机号码										|
| mobile | String| No | mobile phone number |
| email				| String| 否	| 邮箱地址										|
| email | String| No | email address |
| role				| Array	| 否	| 用户角色列表，由role_id组成的数组[详情查看](https://uniapp.dcloud.net.cn/uniCloud/uni-id-summary.html#rbac)。<br/>当值为：`["admin"]`表示为超级管理员，不受任何权限限制；|
| role | Array | No | A list of user roles, an array composed of role_id [View details](https://uniapp.dcloud.net.cn/uniCloud/uni-id-summary.html#rbac). <br/>When the value is: `["admin"]` means super administrator, not subject to any authority restrictions;|

签名密钥配置路径： `/cloudfunctions/common/uni-config-center/uni-im/config.json` 
Signing key configuration path: `/cloudfunctions/common/uni-config-center/uni-im/config.json`

**Nodejs环境，生成signedData示例代码：**
**Nodejs environment, generate signedData sample code:**
```js
const jwtSecret = "jwtSecretDemo"; //切勿泄露此密钥，且应当与uni-config-center中配置的一致
const jwt = require("jsonwebtoken");
const payload = {
	"exp":Date.now() + 60 * 1000,//60秒后过期
	"userInfo":{
		"avatar_file":{
			"extname": "",
			"name": "",
			"url":'https://web-assets.dcloud.net.cn/unidoc/zh/unicloudlogo.png'
		},
		"openid":"100001",
		"nickname":"张三",
		"role":["admin"] // 设置该用户为超级管理员，不受任何权限限制
	}
}

// 签名
// sign
let token = jwt.sign(payload, jwtSecret);
console.log(token);

/*
// 验证签名
// verify the signature
try{
	let decoded = jwt.verify(token, jwtSecret);
	console.log(decoded)
}catch{
	console.error("签名验证失败")
}
*/
```


**返回值**
**return value**

|参数名							|类型				|说明			|
|parameter name |type |description |
|--								|--					|--				|
|errCode						|string&#124;number	|错误码			|
| errCode | string&#124;number | error code |
|errMsg							|string				|错误信息			|
| errMsg | string | error message |
|newToken						|object				|新token信息（uniCloud客户端监听到云对象返回newToken，</br>会自动将新token及过期时间存储在storage内。</br>当客户端调用云函数（云对象）的方法时，会自动带上token供服务端校验	|
|&nbsp;&#124;-&nbsp;token		|string				|token			|
|&nbsp;&#124;-&nbsp;tokenExpired|string				|token过期时间	|
|&nbsp;&#124;-&nbsp;tokenExpired| string | token expiration time |


**示例代码：**
**Example code:**

以下为客户端的示例，演示了在客户端中登录之前的账户体系成功后，把signedData传给uni-im，调用uni-im的联登接口。
The following is an example of the client, which demonstrates that after successfully logging in to the previous account system in the client, the signedData is passed to uni-im, and the joint login interface of uni-im is called.

```js
// 1. 导入uniCloud客户端账户体系，用户信息状态管理模块
// 1. Import uniCloud client account system, user information status management module
import {
	mutations as uniIdMutations
} from '@/uni_modules/uni-id-pages/common/store.js';

// 2. 导入uni-im的云对象
// 2. Import the cloud object of uni-im
const uniImCo = uniCloud.importObject("uni-im-co")

// 3. 客户端向传统服务器的登录接口发起请求，验证登录信息无误后：将userInfo通过jwt签名与token一起返回
// 3. The client initiates a request to the login interface of the traditional server, and after verifying that the login information is correct: return the userInfo together with the token through the jwt signature
uni.request({
	data:{
		username:"xxx",
		password:"xxx"
	},
	url:'https://xxx.com/login.php',//你在传统服务端的登录地址（示例链接非真实地址）
	success: async res => {
		const {token,signedData} = res.data
		//4. 存储token实现登录
		//4. Store token for login
		uni.setStorageSync('token',token)
		
		//5. 将签名后的signedData作为参数调用uni-im的登录接口
		//5. Call the login interface of uni-im with the signed signedData as a parameter
		res = await  uniImCo.loginWithJWT(signedData)

		if(res.errCode){
			return uni.showModal({
				content: JSON.stringify(),
				showCancel: false,
				confirmText: '知道了',
			});
		}

		//6. 更新uniId store内的当前用户信息（uni-im显示当前用户头像、昵称时会用到）
		//6. Update the current user information in the uniId store (uni-im will be used when displaying the current user's avatar and nickname)
		await uniIdMutations.updateUserInfo()

		/*
		// 注：uni-im会话列表页面，已内置步骤5、6；如果是登录后，需要立即打开会话页面的项目，直接将signedData作为token传参，可省略步骤5、6。如下：
		// Note: The uni-im session list page has built-in steps 5 and 6; if it is an item that needs to open the session page immediately after logging in, directly pass signedData as a token parameter, and steps 5 and 6 can be omitted. as follows:
		uni.navigateTo({
			url:'/uni_modules/uni-im/pages/index/index?token='+signedData,
			complete: () => {
				uni.hideLoading()
			}
		})
		*/
	}
})
```

**注意：** 登录有效期默认为：2小时；当有效期小于1小时，账号活跃会自动续期。如果与你的系统登录配置不同请修改。配置路径：`uniCloud/cloudfunctions/common/uni-config-center/uni-id/config.json`，配置文档[详情查看](https://uniapp.dcloud.net.cn/uniCloud/uni-id-summary.html#config)
**Note:** The default login validity period is 2 hours; when the validity period is less than 1 hour, the account will be automatically renewed when it is active. If it is different from your system login configuration, please modify it. Configuration path: `uniCloud/cloudfunctions/common/uni-config-center/uni-id/config.json`, configuration document [View details](https://uniapp.dcloud.net.cn/uniCloud/uni-id- summary.html#config)



#### 获取会话列表getConversationList@coGetConversationList
#### Get the conversation list getConversationList@coGetConversationList
**参数说明**
**Parameter Description**

|参数名	|类型	|必填	|说明			|
|Parameter name |Type |Required |Description |
|--		|--		|--		|--				|
|limit	|number	|否		|数量，默认值：500	|
| limit | number | no | number, default: 500 |
|page	|number	|是		|页码			|
| page | number | Yes | page number |

**返回值**
**return value**

|参数名	|类型				|说明		|
|parameter name |type |description |
|--		|--					|--			|
|errCode|string&#124;number	|错误码，0表示成功	|
| errCode| string&#124;number | Error code, 0 means success |
|errMsg	|string				|错误信息	|
| errMsg | string | error message |
|data	|array				|会话数据	|
| data | array | session data |

#### 发送聊天消息sendMsg@coSendMsg
#### Send a chat message sendMsg@coSendMsg
|参数名	|类型	|必填	|说明			|
|Parameter name |Type |Required |Description |
|--		|--		|--		|--				|
|to_uid	|string	|否		|接受消息的用户id	|
| to_uid | string | No | The id of the user who received the message |
|appId	|string	|是		|接收消息的appId；如果你是2个不同appId的应用相互发，请修改此值为相对的appId	|
| appId | string | Yes | the appId that receives the message; if you send two apps with different appIds to each other, please change this value to the relative appId |
|type	|string	|是		|消息类型，暂时仅支持：text(表示文本类型)、image(表示图片类型)|
| type | string |yes |message type, currently only supported: text (indicates text type), image (indicates image type)|
|body	|string	|是		|消息内容，`type = text`时为文本内容.`type = image`时为图片网络地址|
| body | string |Yes |Message content, text content when `type = text`. Image network address when `type = image`|

**返回值**
**return value**

|参数名							|类型				|说明			|
|parameter name |type |description |
|--								|--					|--				|
|errCode						|string&#124;number	|错误码，0表示成功	|
| errCode | string&#124;number | Error code, 0 means success |
|errMsg							|string				|错误信息			|
|data							|object				|				|
|&nbsp;&#124;-&nbsp;create_time	|无					|创建时间			|
|&nbsp;&#124;-&nbsp;create_time |None |Create time|

**接口形式**
**Interface form**

```js
const uniImCo = uniCloud.importObject('uni-im-co', {
  customUI: true
});
await uniImCo.sendMsg({
  to_uid:"630cacf46293d20001f3c368",
  type:"text",
  body:"您好！"
})
```

## 服务端配置@uni-im-cloud-config 
## Server configuration @uni-im-cloud-config
路径：`/uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/uni-im/config.json`
Path: `/uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/uni-im/config.json`

|字段名				|数据类型		|说明													|
|Field Name |Data Type |Description |
|--					|--				|--														|
|jwtSecret			|string			|WJT联登录密钥											|
| jwtSecret | string | WJT joint login key |
|admin_uid			|string/boolean	|客服用户id，不限制则填`false`即可；仅conversation_grade的值为100时有效						|
| admin_uid | string/boolean | Customer service user id, if there is no limit, fill in `false`; it is only valid when the value of conversation_grade is 100 |
|conversation_grade	|int			|控制发起会话的条件，详情[会话控制](#conversation_grade)|
| conversation_grade | int | Control the conditions for initiating a conversation, details[conversation control](#conversation_grade)|

### 会话控制@conversation_grade
### Conversation Control @conversation_grade

|值	|说明								|
|value |description|
|--	|--					|
|0	|不限制								|
| 0 | no limit |
|100|仅限当前用户向：客服、好友、群成员发起会话	|
| 100|Only current users can initiate conversations with: customer service, friends, and group members |
|200|仅限当前用户向：好友或群成员发起会话		|
| 200|Only the current user can initiate a conversation with: friends or group members|


## 客户端sdk@clientSkd
## client sdk@clientSkd
### Vuex状态管理  
### Vuex state management
uni-im的数据通过Vuex进行状态管理，如果你不了解Vuex[详情参考](https://v3.vuex.vuejs.org/zh/)。
The data of uni-im is managed by Vuex. If you don’t know Vuex[details](https://v3.vuex.vuejs.org/zh/).

这种中心化响应式的数据管理，在用户切换聊天会话时，数据不会不重头加载；降低获取数据的网络请求次数，提高了效率，带来更好的用户体验。
This kind of centralized responsive data management, when the user switches chat sessions, the data will not be reloaded; the number of network requests to obtain data is reduced, the efficiency is improved, and a better user experience is brought.

文件路径：`/uni_modules/uni-im/common/store.js`
File path: `/uni_modules/uni-im/common/store.js`

#### state

|名称					|类型		|说明												|
|Name |Type |Description |
|--						|--			|--													|
|conversationDatas		|object		|由多个[会话对象](#conversation)组成，以会话id为key		|
| conversationDatas | object | Consists of multiple [conversation objects](#conversation), with session id as key |
|currentConversationId	|string		|正在对话的会话id										|
| currentConversationId | string | the session id of the ongoing conversation |
|heartbeat				|timestamp	|心跳（精确到秒）		|
| heartbeat | timestamp | heartbeat (accurate to second) |

概念说明：
Concept Note:

##### 心跳 heartbeat
##### heartbeat heartbeat
uni-im的会话列表和消息列表，需要显示实时的发生时间。而一个应用开启太多的定时器，会消耗大量的系统性能。
The conversation list and message list of uni-im need to display the real-time occurrence time. And if an application starts too many timers, it will consume a lot of system performance.

所以uni-im提供了一个响应式数据`heartbeat`，挂载在Vuex，由uniImInit方法：用一个定时器刷新。
So uni-im provides a responsive data `heartbeat`, mounted on Vuex, by uniImInit method: refresh with a timer.


##### 会话对象 conversation@conversation
##### conversation object conversation@conversation

|属性名				|类型			|说明											|
|Property Name |Type |Description |
|--					|--				|--												|
|id					|string			|当前会话id										|
| id | string | current session id |
|title				|string			|普通会话为对方的用户名或昵称、群会话为群昵称	|
| title | string |Normal session is the user name or nickname of the other party, group session is the group nickname |
|avatar_file		|uniCloud file	|普通会话为对方的用户头像、群会话为群头像		|
| avatar_file | uniCloud file |Ordinary session is the user avatar of the other party, group session is the group avatar |
|owner_uid			|string			|所属用户id										|
| owner_uid | string |Owner ID |
|unread_count		|number			|未读消息数										|
| unread_count | number | number of unread messages |
|user_id			|string			|对话的用户id（群聊会话时为空）					|
| user_id | string | The user id of the conversation (empty for group chat sessions) |
|group_id			|string			|对话的群聊id（普通会话时为空）					|
| group_id | string | The group chat id of the conversation (empty for normal conversations) |
|update_time		|timestamp		|更新时间（每次会话会更新）						|
| update_time | timestamp |Update time (updated every session) |
|msgList			|array			|当前会话聊天数据列表							|
| msgList | array |Current session chat data list |
|chatText			|string			|当前会话的文本框文字内容						|
| chatText | string |The text box text content of the current session |

#### getters

|名称				|参数	|类型	|说明											|
|Name |Parameter |Type |Description |
|--					|--		|--		|--												|
|conversationList	|无		|array	|排序后的会话对象数据列表，与conversationDatas为映射关系|
| conversationList |None | array |Sorted list of conversation object data, mapping relationship with conversationDatas|
|conversation		|会话id	|object	|传入会话id获取会话								|
| conversation | session id | object | pass in the session id to get the session |
|unread_count		|无		|string	|当前应用总未读消息数								|
| unread_count | None | string | The total number of unread messages of the current application |

#### mutations

|方法名						|参数												|说明								|
|Method Name |Parameters |Description |
|--							|--													|--									|
|setCurrentConversationId	|会话id												|设置全局变量 正在聊天的用户的会话id|
| setCurrentConversationId | session id | set global variable session id of the user who is chatting |
|mergeConversationDatas		|会话数据												|合并（新增/覆盖）会话数据到列表	|
| mergeConversationDatas | Conversation Data | Merge (add/overwrite) conversation data into a list |
|updateConversation			|[id, data, cover]依次为：会话id，会话数据，是否覆盖		|更新会话							|
| updateConversation | [id, data, cover] in turn: session id, session data, whether to cover | update session |
|updateTimestamp			|无													|更新心跳时间戳						|
| updateTimestamp | None | Update heartbeat timestamp |

#### actions

|方法名					|参数											|说明					|
|Method Name |Parameters |Description |
|--						|--												|--						|
|clearUnreadCount		|无												|清空当前会话未读消息数	|
| clearUnreadCount | None | Clear the number of unread messages in the current session |
|loadMoreConversation	|可选参数`conversation_id`，用于指定要加载的会话id	|加载更多会话数据		|
| loadMoreConversation | optional parameter `conversation_id`, used to specify the conversation id to load | load more conversation data |
|setMsgList				|详见[setMsgList 说明](#setMsgListParam)			|设置消息列表			|
| setMsgList | See [setMsgList Description](#setMsgListParam) | set message list |

**setMsgList 说明**@setMsgListParam
**setMsgList Description**@setMsgListParam

|参数名			|类型			|是否必填				|说明																|
|Parameter name |Type |Required |Description |
|--				|--				|--						|--																	|
|conversation_id|string			|是						|会话id																|
|conversation_id| string |yes |conversation id|
|action			|string			|否						|操作类型，默认值为`set`，详见[action说明](#setMsgListActionParam)	|
| action | string | No | Operation type, the default value is `set`, see [action description](#setMsgListActionParam) |
|data			|object、array	|是						|聊天数据	。更新或插入数据时，data为单条消息内容，类型：object。设置聊天列表数据时，为多条消息集合，类型：array。|
| data | object, array | Yes | chat data. When updating or inserting data, data is the content of a single message, type: object. When setting chat list data, it is a collection of multiple messages, type: array. |
|id				|string			|`action = update`时必填 |要更新的消息id														|
| id | string | required when `action = update` | message id to update |
|save			|boolean		|否						|是否保存到storage,默认值为`false`									|
| save | boolean |No |Whether to save to storage, the default value is `false` |

**action 说明** @setMsgListActionParam
**action description** @setMsgListActionParam

|参数名	|说明				|
|parameter name |description |
|--		|--					|
|set	|设置聊天列表数据		|
| set | set chat list data |
|push	|向后插入数据			|
| push | insert data backwards |
|unshift|向前插入数据			|
| unshift| insert data forward |
|update	|更新某一条聊天数据	|
| update |Update a chat data |

### 聊天消息管理类库  
### Chat message management library
为了提高聊天数据的获取速度，`uni-im`将历史消息存储在本地的storage中。
In order to improve the speed of chat data acquisition, `uni-im` stores historical messages in local storage.

因此，聊天数据由：云端数库中的数据和本地storage数据两部分组成。
Therefore, the chat data consists of two parts: data in cloud database and local storage data.

而何时应当从网络拉取数据，何时从本地获取数据是一个复杂的逻辑。uni-im将它封装成一个im消息数据操作类。
And when to pull data from the network and when to get data locally is a complex logic. uni-im encapsulates it into an im message data operation class.

使用示例：
Example usage:
```js
import MsgManager from '@/uni_modules/uni-im/common/msgManager.js';
const currentConversation = this.$store.uniIm.getters.conversation('当前会话id')
const msg = new MsgManager(currentConversation);
//拉取更多数据
// fetch more data
let data = await this.msg.getMore();
```

|属性名		|类型		|说明														|
|Property Name |Type |Description |
|--			|--			|--															|
|isInit		|boolean	|是否已经加载过首页数据											|
| isInit | boolean |Whether the home page data has been loaded |
|getMore	|function	|获取更多历史聊天数据（如果数据来源服务端，会自动保存到storage）		|
| getMore | function | Get more historical chat data (if the data comes from the server, it will be automatically saved to storage) |
|pageLimit	|number		|配置的聊天数据分页值											|
| pageLimit | number | Configured chat data pagination value |

### storage操作库
### storage operation library
uni-app的[数据缓存](https://uniapp.dcloud.net.cn/api/storage/storage.html#)，是通过不同的key来存储和获取数据。
[Data Cache](https://uniapp.dcloud.net.cn/api/storage/storage.html#) of uni-app stores and retrieves data through different keys.

如下示例：
For example:
```js
// 设置数据
// set data
uni.setStorageSync('storage_key', 'hello');
// 读取数据
// read data
uni.getStorageSync('storage_key');
```

以不同的key值，单独存储一组数据；
Store a set of data separately with different key values;

而im聊天数据可能非常庞大，需要分页存储，且支持按时间和页码检索。
However, im chat data may be very large and needs to be stored in pages, and it supports retrieval by time and page number.

uni-im-storage应需而生，封装了这些方法：
uni-im-storage was born on demand and encapsulated these methods:

|方法名	|说明		|
|Method name |Description |
|--			|--			|
|update	|更新数据	[详见](#update)	|
| update | update data [see details](#update) |
|getData|获取数据	[详见](#getData)	|
| getData|Get data [see details](#getData) |
|append	|向某个会话的聊天数据中添加一条聊天数据（一般用于收到）	|
| append | Add a piece of chat data to the chat data of a session (generally used for receiving) |
|insert	|向前插入数据	|
| insert | insert data forward |

uni-im-storage 还有一个可以配置的属性值`pageLimit`即：加载历史聊天数据时每一页的数据。
uni-im-storage also has a configurable attribute value `pageLimit`, that is, the data of each page when loading historical chat data.

配置方式，修改路径`/uni_modules/uni-im/common/uni-im-storage.js`第二行pageLimit的值（默认值：`30`）。
Configuration method, modify the value of pageLimit in the second line of the path `/uni_modules/uni-im/common/uni-im-storage.js` (default value: `30`).

**update 参数说明**@updateMsgStorage
**update parameter description**@updateMsgStorage

|参数名	|类型	|是否必填	|说明		|
|Parameter name |Type |Required |Description |
|--		|--		|--		|--			|
|id		|string	|是		|消息id		|
| id | string | yes | message id |
|data	|object	|是		|消息数据		|
| data | object | Yes | message data |

**getData 参数说明**@getData
**getData parameter description**@getData

|参数名			|类型	|是否必填							|说明								|
|Parameter name |Type |Required |Description |
|--				|--		|--								|--									|
|conversation_id|string	|是								|会话id								|
|conversation_id| string |yes |conversation id|
|limit			|object	|否								|获取的条数，默认为配置的pageLimit的值	|
| limit | object |No |The number of items to obtain, the default is the value of the configured pageLimit |
|page			|object	|page、maxTime、miniTime 三选一	|页码。支持负数，如：-1表示倒数第一页		|
| page | object | choose one of page, maxTime, miniTime | page number. Negative numbers are supported, such as: -1 means the last page |
|maxTime		|object	|page、maxTime、miniTime 三选一	|获取的消息的最大时间					|
| maxTime | object | Choose one of page, maxTime, miniTime | The maximum time of the obtained message |
|miniTime		|object	|page、maxTime、miniTime 三选一	|暂不支持								|
| miniTime | object | Choose one of page, maxTime, miniTime | Not supported yet |

#### 工具类库@utils
#### Tool class library @utils
utils封装了uni-im常用方法的模块，路径：`/uni_modules/uni-im/common/utils.js`
utils encapsulates the modules of common methods of uni-im, path: `/uni_modules/uni-im/common/utils.js`

|名称				|类型		|说明												|入参					|返回值												|
|Name |Type |Description |Input parameter |Return value |
|--					|--			|--													|--						|--													|
|init			|function	|初始化uni-im（监听聊天消息，定时每秒更新心跳值为当前时间戳）|无						|无													|
| init | function |Initialize uni-im (monitor chat messages, regularly update the heartbeat value every second to the current timestamp) |None |None |
|getConversationId	|function	|获取会话id											|与你对话的用户id或群id	|无													|
| getConversationId | function | Get the conversation id | the user id or group id you are talking to | None |
|formatTime			|function	|时间戳转化为格式化									|时间戳：timestamp		|格式化后的时间字符串。如：x年x月x日，昨天，下午，1小时前等	|
| formatTime | function | convert timestamp to format | timestamp: timestamp | formatted time string. Such as: x year x month x day, yesterday, afternoon, 1 hour ago, etc |


## 项目升级  
## Project upgrade
uni-im遵循uni-app的插件模块化规范，即：[uni_modules](https://uniapp.dcloud.io/uni_modules)。
uni-im follows the uni-app plug-in modular specification, namely: [uni_modules](https://uniapp.dcloud.io/uni_modules).

在项目根目录下的`uni_modules`目录下，以插件ID即`uni-im`为插件文件夹命名，在该目录右键也会看到“从插件市场更新”选项，点击即可更新该插件。也可以用插件市场web界面下载覆盖。
In the `uni_modules` directory under the project root directory, name the plug-in folder with the plug-in ID ie `uni-im`, right click on this directory and you will see the option "Update from the plug-in market", click to update the plug-in. Overlays can also be downloaded using the plugin marketplace web interface.

### 升级旧项目为 uni-im 1.4.0（群聊版） 注意事项
### Upgrade the old project to uni-im 1.4.0 (group chat version) Notes
此版本更新了`uni-im-conversation`表的 `user_id` 字段名为 `friend_uid` &&  `owner_uid` 字段名为 `user_id`。
This version updates the `user_id` field of `uni-im-conversation` table named `friend_uid` && `owner_uid` field named `user_id`.
旧版uni-im，需通过：`uniCloud/database/JQL查询.jql` 执行以下jql语句，修改字段名
For the old version of uni-im, you need to pass: `uniCloud/database/JQL query.jql` to execute the following jql statement and modify the field name
1. 先执行：
1. Execute first:
```js
db.collection('uni-im-conversation').update({
	"user_id": db.command.rename('friend_uid')
})
```
2. 再执行：（**注意：不要两句一起执行，也别弄反顺序**）
2. Execute again: (**Note: Do not execute the two sentences together, and do not reverse the order**)
```js
db.collection('uni-im-conversation').update({
	owner_uid: db.command.rename('user_id')
})
```

>此版本新增`会话控制`配置，[详情查看](#conversation_grade) 
>This version adds `conversation control` configuration, [View details](#conversation_grade)



## 许可协议
## agreement
uni-im源码使用许可协议
uni-im source code license agreement

2022年10月
October 2022

本许可协议，是数字天堂（北京）网络技术有限公司（以下简称DCloud）对其所拥有著作权的“DCloud uni-im”（以下简称软件），提供的使用许可协议。
This license agreement is a license agreement provided by Digital Paradise (Beijing) Network Technology Co., Ltd. (hereinafter referred to as DCloud) to its copyrighted "DCloud uni-im" (hereinafter referred to as software).

您对“软件”的复制、使用、修改及分发受本许可协议的条款的约束，如您不接受本协议，则不能使用、复制、修改本软件。
Your copying, use, modification and distribution of the "Software" are subject to the terms of this License Agreement. If you do not accept this Agreement, you cannot use, copy or modify the Software.

授权许可范围
License scope

a) 授予您永久性的、全球性的、免费的、非独占的、不可撤销的本软件的源码使用许可，您可以使用这些源码制作自己的应用。
a) Grant you a perpetual, global, free, non-exclusive, irrevocable license to use the source code of this software, and you can use these source codes to make your own applications.

b) 您只能在DCloud产品体系内使用本软件及其源码。您不能将源码修改后运行在DCloud产品体系之外的环境，比如客户端脱离uni-app，或服务端脱离uniCloud。
b) You can only use the software and its source code within the DCloud product system. You cannot modify the source code to run in an environment outside the DCloud product system, for example, the client is separated from uni-app, or the server is separated from uniCloud.

c) DCloud未向您授权商标使用许可。您在根据本软件源码制作自己的应用时，需以自己的名义发布软件，而不是以DCloud名义发布。
c) DCloud does not authorize you to use the trademark. When you make your own application based on the source code of this software, you need to release the software in your own name, not in the name of DCloud.

d) 本协议不构成代理关系。
d) This agreement does not create an agency relationship.

DCloud的责任限制
DCloud's Limitation of Liability
“软件”在提供时不带任何明示或默示的担保。在任何情况下，DCloud不对任何人因使用“软件”而引发的任何直接或间接损失承担责任，不论因何种原因导致或者基于何种法律理论,即使其曾被建议有此种损失的可能性。
THE SOFTWARE IS PROVIDED WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED. In any case, DCloud shall not be liable for any direct or indirect loss caused by anyone using the "software", regardless of the cause or based on any legal theory, even if it has been suggested that there is the possibility of such loss .

您的责任限制
Limitation of your liability

a) 您需要在授权许可范围内使用软件。
a) You need to use the software within the scope of the license.

b) 您在分发自己的应用时，不得侵犯DCloud商标和名誉权利。
b) You must not infringe DCloud's trademark and reputation rights when distributing your own applications.

c) 您不得进行破解、反编译、套壳等侵害DCloud知识产权的行为。您不得利用DCloud系统漏洞谋利或侵害DCloud利益，如您发现DCloud系统漏洞应第一时间通知DCloud。您不得进行攻击DCloud的服务器、网络等妨碍DCloud运营的行为。您不得利用DCloud的产品进行与DCloud争夺开发者的行为。
c) You are not allowed to crack, decompile, shell and other acts that infringe DCloud's intellectual property rights. You are not allowed to take advantage of DCloud system loopholes to seek profit or infringe on DCloud’s interests. If you discover DCloud system loopholes, you should notify DCloud as soon as possible. You are not allowed to attack DCloud's server, network and other actions that hinder DCloud's operation. You may not use DCloud's products to compete with DCloud for developers.

d) 如您违反本许可协议，需承担因此给DCloud造成的损失。
d) If you violate this license agreement, you shall bear the losses caused to DCloud.

本协议签订地点为中华人民共和国北京市海淀区。
The place where this agreement is signed is Haidian District, Beijing, People's Republic of China.

根据发展，DCloud可能会对本协议进行修改。修改时，DCloud会在产品或者网页中显著的位置发布相关信息以便及时通知到用户。如果您选择继续使用本框架，即表示您同意接受这些修改。
According to the development, DCloud may modify this Agreement. When modifying, DCloud will publish relevant information in a prominent position on the product or webpage to notify users in a timely manner. If you choose to continue using the Framework, you agree to accept these modifications.

条款结束
end of terms
